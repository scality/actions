name: 'Smart Nightly Trigger'
description: 'Intelligently decides whether to trigger nightly workflows based on commits and schedule'

# Required permissions for the calling workflow:
#   contents: read      # For checking out the repository and reading git history
#   actions: read       # For querying workflow run status via GitHub API
#
# Note: The access_token input must be a Personal Access Token (PAT) or GitHub App token
#       with 'repo' and 'workflow' scopes to trigger workflows.
#       The default GITHUB_TOKEN cannot trigger workflows due to GitHub security restrictions.

inputs:
  branch:
    description: 'Branch to check and trigger workflow for (defaults to repository default branch)'
    required: false
  workflow:
    description: 'Workflow to trigger (e.g., nightly.yaml)'
    required: true
    default: 'nightly.yaml'
  access_token:
    description: 'Access token for triggering workflows (required)'
    required: true
  run-workflow:
    description: 'Whether to actually run the workflow or only make decision (default: true)'
    required: false
    default: 'true'
  max-start-if-last-failed:
    description: 'Maximum number of times to retry if last workflow run on last commit failed (default: 0 - disabled)'
    required: false
    default: '0'
  commit-check-period:
    description: 'Time window in days to check for recent commits (default: 1 day)'
    required: false
    default: '1'

outputs:
  trigger:
    description: 'Whether the workflow should be triggered (true/false)'
    value: ${{ steps.decide.outputs.trigger }}
  reason:
    description: 'Reason for the trigger decision'
    value: ${{ steps.decide.outputs.reason }}
  last_commit_time:
    description: 'Timestamp of the last commit'
    value: ${{ steps.check-commits.outputs.last_commit_time }}
  days_since_last_run:
    description: 'Days since last workflow run'
    value: ${{ steps.check-status.outputs.days_since_last_run }}

runs:
  using: composite
  steps:
    - name: Set target branch
      id: set-branch
      shell: bash
      run: |
        BRANCH="${{ inputs.branch || github.event.repository.default_branch }}"
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Target branch: $BRANCH"

    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: ${{ steps.set-branch.outputs.branch }}
        fetch-depth: 1

    - name: Get last commit info
      id: check-commits
      shell: bash
      run: |
        # Get the timestamp and SHA of the last commit
        last_commit_time=$(git log -1 --format=%ct)
        last_commit_sha=$(git log -1 --format=%H)
        echo "last_commit_time=$last_commit_time" >> $GITHUB_OUTPUT
        echo "last_commit_sha=$last_commit_sha" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Last commit timestamp: $last_commit_time"
        echo "ğŸ“Š Last commit SHA: $last_commit_sha"

    - name: Check latest workflow run status
      id: check-status
      shell: bash
      env:
        GITHUB_TOKEN: ${{ github.token }}
        BRANCH: ${{ steps.set-branch.outputs.branch }}
      run: |
        # Get the latest workflow run for this branch
        latest_run=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${{ github.repository }}/actions/workflows/${{ inputs.workflow }}/runs?branch=${BRANCH}&per_page=1" \
          --jq '.workflow_runs[0]')

        if [ -z "$latest_run" ] || [ "$latest_run" = "null" ]; then
          echo "âŒ No previous workflow runs found"
          echo "status=not_found" >> $GITHUB_OUTPUT
          echo "days_since_last_run=999" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Extract status and conclusion
        status=$(echo "$latest_run" | jq -r '.status')
        conclusion=$(echo "$latest_run" | jq -r '.conclusion')
        run_id=$(echo "$latest_run" | jq -r '.id')
        created_at=$(echo "$latest_run" | jq -r '.created_at')

        echo "status=$status" >> $GITHUB_OUTPUT
        echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
        echo "run_id=$run_id" >> $GITHUB_OUTPUT

        # Calculate days since last run
        if [ -n "$created_at" ] && [ "$created_at" != "null" ]; then
          last_run_epoch=$(date -d "$created_at" +%s)
          current_epoch=$(date +%s)
          days_since=$((($current_epoch - $last_run_epoch) / 86400))
          echo "days_since_last_run=$days_since" >> $GITHUB_OUTPUT
          echo "ğŸ“… Last run was $days_since days ago"
        else
          echo "days_since_last_run=999" >> $GITHUB_OUTPUT
        fi

        echo "ğŸ” Latest workflow run #$run_id: status=$status, conclusion=$conclusion"

    - name: Count workflow runs on last commit
      id: check-runs-on-commit
      shell: bash
      env:
        GITHUB_TOKEN: ${{ github.token }}
        COMMIT_SHA: ${{ steps.check-commits.outputs.last_commit_sha }}
      run: |
        # Get all workflow runs for this specific commit SHA
        runs=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${{ github.repository }}/actions/workflows/${{ inputs.workflow }}/runs?head_sha=${COMMIT_SHA}" \
          --jq '.workflow_runs')

        # Count total runs
        run_count=$(echo "$runs" | jq 'length')
        echo "run_count=$run_count" >> $GITHUB_OUTPUT
        echo "ğŸ”¢ Total runs on commit ${COMMIT_SHA:0:8}: $run_count"

        # Get the most recent run's conclusion
        if [ "$run_count" -gt 0 ]; then
          last_run_conclusion=$(echo "$runs" | jq -r '.[0].conclusion')
          last_run_status=$(echo "$runs" | jq -r '.[0].status')
          echo "last_run_on_commit_conclusion=$last_run_conclusion" >> $GITHUB_OUTPUT
          echo "last_run_on_commit_status=$last_run_status" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Last run on this commit: status=$last_run_status, conclusion=$last_run_conclusion"
        else
          echo "last_run_on_commit_conclusion=not_found" >> $GITHUB_OUTPUT
          echo "last_run_on_commit_status=not_found" >> $GITHUB_OUTPUT
          echo "ğŸ“Š No runs found on this commit"
        fi

    - name: Decide whether to trigger workflow
      id: decide
      shell: bash
      env:
        LAST_COMMIT_TIME: ${{ steps.check-commits.outputs.last_commit_time }}
        STATUS: ${{ steps.check-status.outputs.status }}
        DAYS_SINCE: ${{ steps.check-status.outputs.days_since_last_run }}
        RUN_COUNT: ${{ steps.check-runs-on-commit.outputs.run_count }}
        LAST_RUN_CONCLUSION: ${{ steps.check-runs-on-commit.outputs.last_run_on_commit_conclusion }}
        LAST_RUN_STATUS: ${{ steps.check-runs-on-commit.outputs.last_run_on_commit_status }}
        MAX_RETRIES: ${{ inputs.max-start-if-last-failed }}
        COMMIT_CHECK_PERIOD: ${{ inputs.commit-check-period }}
      run: |
        # Run the decision script
        ${{ github.action_path }}/decide-trigger.sh

        # Display results for debugging
        echo "Decision results:"
        cat result.txt

        # Copy results to GITHUB_OUTPUT
        cat result.txt >> $GITHUB_OUTPUT

    - name: Trigger workflow
      if: steps.decide.outputs.trigger == 'true' && inputs.run-workflow == 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.access_token }}
        BRANCH: ${{ steps.set-branch.outputs.branch }}
      run: |
        echo "ğŸ¯ Triggering workflow: ${{ inputs.workflow }} for ${BRANCH}"
        echo "ğŸ“‹ Reason: ${{ steps.decide.outputs.reason }}"
        gh workflow run "${{ inputs.workflow }}" --ref="${BRANCH}"

    - name: Log decision
      shell: bash
      env:
        BRANCH: ${{ steps.set-branch.outputs.branch }}
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Smart Nightly Trigger Decision Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Branch: ${BRANCH}"
        echo "Trigger: ${{ steps.decide.outputs.trigger }}"
        echo "Reason: ${{ steps.decide.outputs.reason }}"
        echo "Last commit time: ${{ steps.check-commits.outputs.last_commit_time }}"
        echo "Days since last run: ${{ steps.check-status.outputs.days_since_last_run }}"
        echo "Last status: ${{ steps.check-status.outputs.conclusion }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
